<!DOCTYPE html>
<html>
<head>
    <title>부동산 거래 정보</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .table-container { margin: 20px; overflow-y: scroll; height: 800px; } /* 테이블 컨테이너 높이 설정 및 스크롤 기능 활성화 */
        h1 { text-align: center; margin: 20px 0; color: #333; }
        .code-column { font-family: monospace; }
        .district-filter { margin-bottom: 20px; }
        .district-filter button { margin-right: 5px; }
        .row { display: flex; } /* flexbox 레이아웃 적용 */
        .col-md-4 { width: 35%; } /* 옵션 창 너비 조정 */
        .col-md-8 { width: 65%; } /* 데이터 시트 너비 조정 */
    </style>
</head>
<body>
    <div class="container">
        <h1>서울시 아파트 실거래가 정보</h1>
        <div class="row">
            <div class="col-md-4">
                <!-- 옵션 창 -->
                <div class="option-panel">
                    <!-- 구 이름 필터 버튼 -->
                    <div class="district-filter">
                        {% for code, district in district_mapping.items() %}
                        <button class="btn btn-primary btn-sm district-btn" data-district="{{ district }}" style="margin: 5px;">{{ district }}</button>
                        {% endfor %}
                    </div>
                    <style>
                        .district-filter button {
                            background-color: #007bff; /* Blue background */
                            color: white; /* White text */
                            border: 1px solid #007bff; /* Blue border */
                            border-radius: 5px; /* Rounded corners */
                            padding: 8px 15px; /* Padding */
                            margin-bottom: 5px; /* Margin between buttons */
                            cursor: pointer; /* Pointer cursor on hover */
                            transition: background-color 0.3s, color 0.3s; /* Smooth transition for hover effect */
                        }

                        .district-filter button:hover {
                            background-color: white; /* White background on hover */
                            color: #007bff; /* Blue text on hover */
                        }
                    </style>

                    <!-- 검색 폼 -->
                    <div class="search-form">
                        <form id="searchForm">
                            <div class="mb-3">
                                <label for="min_price" class="form-label">최소 거래금액(만원)</label>
                                <input type="number" class="form-control" id="min_price" name="min_price">
                            </div>
                            <div class="mb-3">
                                <label for="start_date" class="form-label">거래 시작일</label>
                                <input type="date" class="form-control" id="start_date" name="start_date">
                            </div>
                            <div class="mb-3">
                                <label for="end_date" class="form-label">거래 종료일</label>
                                <input type="date" class="form-control" id="end_date" name="end_date">
                            </div>
                            <!-- 정렬 필드와 방향을 선택하기 위한 드롭다운 추가 -->
                            <div class="mb-3">
                                <label for="sort_by" class="form-label">정렬 기준</label>
                                <select class="form-select" id="sort_by" name="sort_by">
                                    <option value="dealYear">거래년도</option>
                                    <option value="dealAmount">거래금액</option>
                                    <option value="excluUseAr">전용면적</option>
                                    <!-- 필요한 경우 다른 정렬 기준 추가 -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="sort_order" class="form-label">정렬 순서</label>
                                <select class="form-select" id="sort_order" name="sort_order">
                                    <option value="desc">내림차순</option>
                                    <option value="asc">오름차순</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">검색</button>
                            <button type="button" class="btn btn-secondary" id="resetBtn">초기화</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <!-- 데이터 테이블 -->
                <div class="table-container">
                    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th style="width: 150px; white-space:nowrap;" data-column="district">구</th>
                <th style="width: 300px; white-space:nowrap;" data-column="aptNm">아파트명</th>
                <th style="width: 80px; white-space:nowrap;" data-column="aptDong">동</th>
                <th style="width: 100px; white-space:nowrap;" data-column="dealDate">거래일</th>
                <th style="width: 50px; white-space:nowrap;" data-column="floor">층</th>
                <th style="width: 80px; white-space:nowrap;" data-column="excluUseAr">면적(㎡)</th>
                <th style="width: 120px; white-space:nowrap;" data-column="dealAmount">거래금액(만원)</th>
                <th style="width: 80px; white-space:nowrap;" data-column="buildYear">건축년도</th>
                <th style="width: 150px; white-space:nowrap;" data-column="umdNm">지역</th>
            </tr>
        </thead>
                        <style>
                            #propertyTableBody td {
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                max-width: 300px; /* Adjust as needed */
                            }
                        </style>
                        <tbody id="propertyTableBody">
                            <!-- 데이터가 여기에 동적으로 추가됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <style>
        #propertyTableBody td {
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentPage = 0;
        let allDataLoaded = false; // 모든 데이터가 로드되었는지 추적
        const limit = 20;
        let currentDistrict = null; // 현재 선택된 구
        let currentSortBy = 'dealYear'; // 현재 정렬 기준
        let currentSortOrder = 'desc'; // 현재 정렬 방향
        let currentMinPrice = '';
        let currentStartDate = '';
        let currentEndDate = '';
        let currentColumnFilter = null; // 현재 컬럼 필터
        let currentColumnValue = null; // 현재 컬럼 필터 값

        function loadData(page, q, min_price, start_date, end_date, sort_by, sort_order, column_filter, column_value) {
            if (allDataLoaded) return;
            $.ajax({
                url: '/api/search',
                data: {
                    q: q,
                    min_price: min_price,
                    max_price: '',
                    start_date: start_date,
                    end_date: end_date,
                    limit: limit,
                    offset: page * limit,
                    sort_by: sort_by,
                    sort_order: sort_order,
                    column_filter: column_filter, // 컬럼 필터 추가
                    column_value: column_value // 컬럼 필터 값 추가
                },
                success: function(data) {
                    if (data.length === 0) {
                        allDataLoaded = true;
                        return;
                    }
                    updateTable(data);
                },
                error: function(error) {
                    console.error("Error fetching data:", error);
                }
            });
        }

        function updateTable(data) {
            const tbody = $('#propertyTableBody');
            data.forEach(prop => {
                const districtName = currentDistrict ? currentDistrict : getDistrictName(prop.sggCd).trim();
                tbody.append(`
                    <tr>
                        <td>${districtName}</td>
                        <td>${prop.aptNm}</td>
                        <td>${prop.aptDong}</td>
                        <td>${prop.dealYear}-${prop.dealMonth}-${prop.dealDay}</td>
                        <td>${prop.floor}층</td>
                        <td>${prop.excluUseAr}</td>
                        <td>${prop.dealAmount}</td>
                        <td>${prop.buildYear}</td>
                        <td>${prop.umdNm}</td>
                    </tr>
                `);
            });
        }

        // 법정동 코드를 구 이름으로 변환하는 함수
        function getDistrictName(sggCd) {
            const districtMap = JSON.parse('{{ district_mapping | tojson | safe }}');
            return districtMap[sggCd] || '기타';
        }

        $(document).ready(function() {
            loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder, currentColumnFilter, currentColumnValue);

            $('.table-container').on('scroll', function() {
                if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
                    currentPage++;
                    loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder, currentColumnFilter, currentColumnValue);
                }
            });

            $(document).on('click', '.district-btn', function() {
                currentDistrict = $(this).data('district');
                currentColumnFilter = null; // 구 필터 변경 시 컬럼 필터 초기화
                currentColumnValue = null;
                currentPage = 0;
                $('#propertyTableBody').empty();
                allDataLoaded = false;
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder, currentColumnFilter, currentColumnValue);
            });

            $('#searchForm').on('submit', function(e) {
                e.preventDefault();
                currentMinPrice = $('#min_price').val();
                currentStartDate = $('#start_date').val();
                currentEndDate = $('#end_date').val();
                currentSortBy = $('#sort_by').val();
                currentSortOrder = $('#sort_order').val();
                currentPage = 0;
                $('#propertyTableBody').empty();
                allDataLoaded = false;
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder, currentColumnFilter, currentColumnValue);
            });

            $('#resetBtn').on('click', function() {
                currentDistrict = null;
                currentColumnFilter = null; // 초기화 버튼 클릭 시 컬럼 필터 초기화
                currentColumnValue = null;
                currentMinPrice = '';
                currentStartDate = '';
                currentEndDate = '';
                currentSortBy = 'dealYear';
                currentSortOrder = 'desc';
                currentPage = 0;
                $('#propertyTableBody').empty();
                allDataLoaded = false;
                $('#min_price').val('');
                $('#start_date').val('');
                $('#end_date').val('');
                $('#sort_by').val('dealYear');
                $('#sort_order').val('desc');
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder, currentColumnFilter, currentColumnValue);
            });

            // 테이블 헤더 클릭 이벤트
            let sortOrders = {}; // 컬럼별 정렬 상태 저장 객체

            $('th[data-column]').on('click', function() {
                const clickedColumn = $(this).data('column');
                if (!sortOrders[clickedColumn]) {
                    sortOrders[clickedColumn] = 'none';
                }

                if (sortOrders[clickedColumn] === 'none') {
                    sortOrders[clickedColumn] = 'asc';
                    currentSortOrder = 'asc';
                } else if (sortOrders[clickedColumn] === 'asc') {
                    sortOrders[clickedColumn] = 'desc';
                    currentSortOrder = 'desc';
                } else if (sortOrders[clickedColumn] === 'desc') {
                    sortOrders[clickedColumn] = 'none';
                    currentSortOrder = 'none'; // 'none' 상태는 정렬 기준을 초기화
                    currentSortBy = 'dealYear'; // 정렬 기준 컬럼도 초기화, 필요에 따라 기본 컬럼 설정
                }

                if (sortOrders[clickedColumn] !== 'none') {
                    currentSortBy = clickedColumn;
                } else {
                    currentSortBy = 'dealYear'; // 정렬 해제 시 기본 정렬 컬럼으로 설정
                    currentSortOrder = 'desc'; // 정렬 해제 시 기본 정렬 순서로 설정
                }


                currentPage = 0;
                $('#propertyTableBody').empty();
                allDataLoaded = false;
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder, currentColumnFilter, currentColumnValue);
            });

            // 테이블 데이터 클릭 이벤트
            $(document).on('click', '#propertyTableBody td', function() {
                const columnIndex = $(this).index();
                const columnHeader = $('th').eq(columnIndex);
                const clickedColumn = columnHeader.data('column');
                const cellValue = $(this).text();

                 if (currentColumnFilter === clickedColumn && currentColumnValue === cellValue) {
                    // 같은 컬럼, 같은 값 다시 클릭 시 필터 해제
                    currentColumnFilter = null;
                    currentColumnValue = null;
                } else {
                    // 다른 컬럼 또는 다른 값 클릭 시 해당 컬럼과 값으로 필터 설정
                    currentColumnFilter = clickedColumn;
                    currentColumnValue = cellValue;
                }

                currentPage = 0;
                $('#propertyTableBody').empty();
                allDataLoaded = false;
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder, currentColumnFilter, currentColumnValue);
            });
        });
    </script>
</body>
</html>
