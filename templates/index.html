<!DOCTYPE html>
<html>
<head>
    <title>부동산 거래 정보</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .table-container { margin: 20px; }
        h1 { text-align: center; margin: 20px 0; color: #333; }
        .code-column { font-family: monospace; }
        .district-filter { margin-bottom: 20px; }
        .district-filter button { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>서울시 아파트 실거래가 정보</h1>

        <!-- 구 이름 필터 버튼 -->
        <div class="district-filter">
            {% for code, district in district_mapping.items() %}
            <button class="btn btn-secondary btn-sm district-btn" data-district="{{ district }}">{{ district }}</button>
            {% endfor %}
        </div>

        <!-- 검색 폼 -->
        <div class="search-form">
            <form id="searchForm">
                <div class="mb-3">
                    <label for="min_price" class="form-label">최소 거래금액(만원)</label>
                    <input type="number" class="form-control" id="min_price" name="min_price">
                </div>
                <div class="mb-3">
                    <label for="start_date" class="form-label">거래 시작일</label>
                    <input type="date" class="form-control" id="start_date" name="start_date">
                </div>
                <div class="mb-3">
                    <label for="end_date" class="form-label">거래 종료일</label>
                    <input type="date" class="form-control" id="end_date" name="end_date">
                </div>
                <!-- 정렬 필드와 방향을 선택하기 위한 드롭다운 추가 -->
                <div class="mb-3">
                    <label for="sort_by" class="form-label">정렬 기준</label>
                    <select class="form-select" id="sort_by" name="sort_by">
                        <option value="dealYear">거래년도</option>
                        <option value="dealAmount">거래금액</option>
                        <option value="excluUseAr">전용면적</option>
                        <!-- 필요한 경우 다른 정렬 기준 추가 -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="sort_order" class="form-label">정렬 순서</label>
                    <select class="form-select" id="sort_order" name="sort_order">
                        <option value="desc">내림차순</option>
                        <option value="asc">오름차순</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">검색</button>
                <button type="button" class="btn btn-secondary" id="resetBtn">초기화</button>
            </form>
        </div>
        <!-- 페이지네이션 -->
        <nav aria-label="Page navigation">
            <ul class="pagination">
                <li class="page-item" id="prevPage">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">«</span>
                    </a>
                </li>
                <!-- 페이지 번호는 여기에 동적으로 추가됩니다 -->
                <li class="page-item" id="nextPage">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">»</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>구</th>
                        <th>아파트명</th>
                        <th>동</th>
                        <th>거래일</th>
                        <th>층</th>
                        <th>면적(㎡)</th>
                        <th>거래금액(만원)</th>
                        <th>건축년도</th>
                        <th>지역</th>
                    </tr>
                </thead>
                <tbody id="propertyTableBody">
                    <!-- 데이터가 여기에 동적으로 추가됩니다 -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentPage = 0;
        const limit = 20;
        let currentDistrict = null; // 현재 선택된 구
        let currentSortBy = 'dealYear'; // 현재 정렬 기준
        let currentSortOrder = 'desc'; // 현재 정렬 방향
        let currentMinPrice = '';
        let currentStartDate = '';
        let currentEndDate = '';
        
        function loadData(page, q, min_price, start_date, end_date, sort_by, sort_order) {
            $.ajax({
                url: '/api/search',
                data: {
                    q: q,
                    min_price: min_price,
                    max_price: '', // max_price는 사용하지 않으므로 빈 문자열로
                    start_date: start_date,
                    end_date: end_date,
                    limit: limit,
                    offset: page * limit,
                    sort_by: sort_by,
                    sort_order: sort_order
                },
                success: function(data) {
                    updateTable(data);
                    updatePagination(page);
                },
                error: function(error) {
                    console.error("Error fetching data:", error);
                }
            });
        }

        function updateTable(data) {
            const tbody = $('#propertyTableBody');
            tbody.empty();
            data.forEach(prop => {
                tbody.append(`
                    <tr>
                        <td>${getDistrictName(prop.sggCd)}</td>
                        <td>${prop.aptNm}</td>
                        <td>${prop.aptDong}</td>
                        <td>${prop.dealYear}-${prop.dealMonth}-${prop.dealDay}</td>
                        <td>${prop.floor}층</td>
                        <td>${prop.excluUseAr}</td>
                        <td>${prop.dealAmount}</td>
                        <td>${prop.buildYear}</td>
                        <td>${prop.umdNm}</td>
                    </tr>
                `);
            });
        }

        // 페이지네이션 업데이트 함수
        function updatePagination(currentPage) {
            const totalPages = 10; // 예시로 10 페이지로 설정
            let pagination = $('.pagination');
            pagination.empty();

            // 이전 페이지 버튼
            pagination.append(`<li class="page-item ${currentPage === 0 ? 'disabled' : ''}" id="prevPage">
                <a class="page-link" href="#" aria-label="Previous" data-page="${currentPage - 1}">
                    <span aria-hidden="true">«</span>
                </a>
            </li>`);

            // 페이지 번호 버튼
            for (let i = 0; i < totalPages; i++) {
                pagination.append(`<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                </li>`);
            }

            // 다음 페이지 버튼
            pagination.append(`<li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}" id="nextPage">
                <a class="page-link" href="#" aria-label="Next" data-page="${currentPage + 1}">
                    <span aria-hidden="true">»</span>
                </a>
            </li>`);
        }

        // 법정동 코드를 구 이름으로 변환하는 함수
        function getDistrictName(sggCd) {
            return '{{ district_mapping }}'[sggCd] || '기타';
        }

        $(document).ready(function() {
            // 페이지 로드 시 초기 데이터 로드
            loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder);

            // 구 이름 버튼 클릭 이벤트
            $(document).on('click', '.district-btn', function() {
                currentDistrict = $(this).data('district');
                currentPage = 0; // 페이지를 0으로 리셋
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder);
            });

            // 페이지네이션 클릭 이벤트
            $(document).on('click', '.page-link', function(e) {
                e.preventDefault();
                const newPage = $(this).data('page');
                if (newPage >= 0) {
                    currentPage = newPage;
                    loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder);
                }
            });

            // 검색 폼 제출 이벤트
            $('#searchForm').on('submit', function(e) {
                e.preventDefault();
                currentMinPrice = $('#min_price').val();
                currentStartDate = $('#start_date').val();
                currentEndDate = $('#end_date').val();
                currentSortBy = $('#sort_by').val();
                currentSortOrder = $('#sort_order').val();
                currentPage = 0; // 페이지를 0으로 리셋
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder);
            });

            // 초기화 버튼 이벤트
            $('#resetBtn').on('click', function() {
                currentDistrict = null;
                currentMinPrice = '';
                currentStartDate = '';
                currentEndDate = '';
                currentSortBy = 'dealYear'; // 기본 정렬 기준
                currentSortOrder = 'desc'; // 기본 정렬 방향
                currentPage = 0; // 페이지를 0으로 리셋
                $('#min_price').val('');
                $('#start_date').val('');
                $('#end_date').val('');
                $('#sort_by').val('dealYear'); // 정렬 기준 드롭다운 초기화
                $('#sort_order').val('desc'); // 정렬 방향 드롭다운 초기화
                loadData(currentPage, currentDistrict, currentMinPrice, currentStartDate, currentEndDate, currentSortBy, currentSortOrder);
            });
        });
    </script>
</body>
</html>